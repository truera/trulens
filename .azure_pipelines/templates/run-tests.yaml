parameters:
  - name: pytestMarker
    type: string
    values:
      - basic
      - optional
      - snowflake
  - name: testSuite
    type: string
    values:
      - unit
      - e2e
      - notebook

steps:
  - bash: |
      set -e
      echo "=== Freeing disk space before tests ==="
      # Clear pip/poetry caches that accumulated during installs
      pip cache purge || true
      rm -rf ~/.cache/pip || true
      rm -rf ~/.cache/pypoetry || true
      # Clear pytest cache
      rm -rf .pytest_cache || true
      find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      # Show disk space
      df -h /
    displayName: Free disk space before ${{ parameters.pytestMarker }} tests

  - bash: |
      set -e
      # Clean up ALL database files to avoid migration errors with legacy schemas
      # Exclude release_dbs which contains reference databases for testing
      # This must run before any TruSession is created
      find . -type f \( -name "*.sqlite" -o -name "*.db" \) -not -path "./release_dbs/*" -delete || true
      echo "Database files cleaned. Starting tests..."
      make test-${{ parameters.testSuite }}-${{ parameters.pytestMarker }}
    condition: or(ne(variables['python-version'], 3.12), ne('${{ parameters.pytestMarker }}', 'snowflake'))
    env:
      # tests make use of various APIs:
      OPENAI_API_KEY: $(OPENAI_API_KEY)
      HUGGINGFACE_API_KEY: $(HUGGINGFACE_API_KEY)
      PINECONE_API_KEY: $(PINECONE_API_KEY)
      PINECONE_ENV: $(PINECONE_ENV)
      HUGGINGFACEHUB_API_TOKEN: $(HUGGINGFACEHUB_API_TOKEN)

      # some tests log into Snowflake.
      SNOWFLAKE_ACCOUNT: $(SNOWFLAKE_ACCOUNT)
      SNOWFLAKE_USER: $(SNOWFLAKE_USER)
      SNOWFLAKE_USER_PASSWORD: $(SNOWFLAKE_USER_PASSWORD)
      SNOWFLAKE_DATABASE: $(SNOWFLAKE_DATABASE)
      SNOWFLAKE_ROLE: $(SNOWFLAKE_ROLE)
      SNOWFLAKE_WAREHOUSE: $(SNOWFLAKE_WAREHOUSE)
    displayName: Run ${{ parameters.pytestMarker }} ${{ parameters.testSuite }} Test Suite
